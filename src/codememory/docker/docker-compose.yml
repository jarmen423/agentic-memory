services:
  # 1. The Brain (Neo4j Database)
  neo4j:
    image: neo4j:5.18.0
    container_name: codemem_neo4j
    ports:
      - "7474:7474" # HTTP Browser
      - "7687:7687" # Bolt Protocol
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
    volumes:
      - neo4j_data:/data

  # 2. The Observer (Ingestion Service)
  ingestor:
    build: .
    container_name: codemem_ingestor
    depends_on:
      - neo4j
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_PASSWORD=password
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      # CRITICAL: Mount the user's current directory to /app/repo inside container
      - ./:/app/repo
    # Command: Watch the mounted repo folder
    command: ["codemem", "watch", "/app/repo"]

  # 3. The Interface (MCP Server)
  mcp-server:
    build: .
    container_name: codemem_mcp
    depends_on:
      - neo4j
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_PASSWORD=password
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8000:8000" # Expose MCP over SSE/HTTP
    command: ["codemem", "serve-mcp"]

volumes:
  neo4j_data: